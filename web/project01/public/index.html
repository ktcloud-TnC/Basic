<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]> <html class="no-js"> <!--<![endif]-->
<html lang="ko">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>kt cloud T&C</title>
        <meta name="description" content="kt cloud T&C 공인교육을 위한 자료입니다.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="main.css">

    </head>
    <body>
        <!-- 왼쪽 비디오 영역 -->
        <aside class="left-side">
            <video autoplay="autoplay" muted="muted" loop="loop">
                <source
                    src="https://ss1.cloud.kt.com:1000/Basic/test/about_top_asset.mp4"
                    type="video/mp4">
                Your browser does not support the video tag.
            </video>
            <img
                class="logo-overlay"
                src="https://ss1.cloud.kt.com:1000/Basic/test/BI.png"
                alt="Company Logo">
        </aside>

        <!-- 오른쪽 컨텐츠 영역 -->
        <main class="right-side">
            <p class="copyright">
                이 자료의 저작권은 kt cloud 에게 있으며, 무단 복사 및 배포를 금지합니다.</p>
            <article class="container">
                <!-- 호스트네임 컨테이너 -->
                <div class="hostname-container">
                    <p style="display:inline">HostName&nbsp;:&nbsp;
                    </p>
                    <p style="color:rgb(5, 126, 11); display:inline">
                        <span id="hostname"></span></p>
                </div>
                <!-- 서버 상태 확인 버튼 -->
                <button class="status-check-btn" id="checkServerStatusButton">Check server status</button>
                <!-- 서비스 제목 -->
                <h1>
                    <div class="right_logo">kt cloud T&C</div>&nbsp;&nbsp;3 Tier 웹 어플리케이션 구축 실습</h1>
                <p style="line-height: 1.5;">
                    <small>이 어플리케이션은 클라우드 서비스의 구축과 관리를 실습하고자 하는 사용자에게 이상적인 환경을 제공합니다.<br>
                        사용자는 이를 통해 클라우드 기반의 웹 서비스 구축에 필요한 실질적인 경험을 쌓을 수 있습니다.</small>
                </p>

                <section class="app-area">
                    <h2>kt cloud service finder&nbsp;<span class="right_logo">app</span></h2>

                    <!-- 파트너 선택 안내 문구 -->
                    <p style="display: inline-block; vertical-align: text-bottom; color: #ffffff;">원하는 서비스를 선택하면 상세한 설명을 확인 할 수 있습니다.</p><br>
                    <small style="position: sticky; z-index: 3; color: #ffffff;">
                        <span class="big-bullet"></span>&nbsp;WAS 서버 내의 에코(Echo) 애플리케이션은 DB 서버에서 서비스 목록을 불러옵니다.<br>
                        <span class="big-bullet"></span>&nbsp;WEB 서버에서 특정 서비스를 누르면 서비스의 설명을 WAS 서버로 호출합니다.<br>
                        <span class="big-bullet"></span>&nbsp;WAS 서버 내의 에코(Echo) 애플리케이션은 DB 서버에서 특정 서비스의 설명을 검색합니다.<br>
                    </small>

                    <br>

                    <!-- 이미지 오버레이 <div class="image-overlay"> <img
                    src="https://ss1.cloud.kt.com:1000/Basic/test/BB.png" alt="KT Cloud"> </div> -->

                    <!-- 여기에 새로운 버튼 추가 -->
                    <button class="add-database-btn" onclick="openAddProductWindow()">
                        <span class="plus-circle">
                            <span class="plus"></span>
                        </span>
                        Add Database
                    </button>
                    <!-- 제품 목록 및 설명 섹션 -->
                    <div class="pro-container">
                        <!-- 왼쪽 영역: 제품 목록 -->
                        <div class="pro-left-box-container">
                            <div class="pro-left-box">
                                <ul id="productList">
                                    <li>
                                        <span class="product-name">상품명</span>
                                        <span class="category-name">/ 카테고리명</span>
                                    </li>
                                    <!-- 반복되는 상품 목록 항목 -->
                                </ul>
                            </div>
                        </div>

                        <!-- 오른쪽 영역: 제품 설명 -->
                        <div class="pro-right-box-container">
                            <div class="pro-right-box">
                                <div id="productDescription">
                                    <!-- 제품 설명 내용 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                <section>
                    <p
                        style="display: inline-block; vertical-align: text-bottom; color: #173d61; font-weight: 600;">각 서버의 CPU,메모리 사용량을 확인하고 과부하 테스트를 통해 오토스케일링 여부를 확인합니다.</p><br>
                    <small>
                        <span class="big-bullet"></span>&nbsp;웹 서버에 스트레스 테스트 도구를 설치한 후 실행하여 CPU 과부하를 유발합니다.<br>
                        <span class="big-bullet"></span>&nbsp;콘솔을 통해 설정한 트리거에 의해 오토스케일링이 작동되는지 확인합니다.</small>
                    <!-- 파트너 테이블 아래에 서버 상태 및 스트레스 테스트 컨테이너 추가 -->
                    <div class="server-status-container">
                        <!-- 웹 서버 상태 박스 -->
                        <div class="server-box">
                            <div class="loader" style="display: none;"></div>
                            <h3>WEB 서버 상태</h3>
                            <div class="status-and-button">
                                <div class="status">
                                    <p style="font-size: large;">CPU 사용량:
                                        <span id="webCpuUsage">&nbsp;0%</span></p>
                                    <p style="font-size: large;">메모리 사용량:
                                        <span id="webMemoryUsage">&nbsp;0%</span></p>
                                </div>
                                <!-- 로더 추가 -->

                                <button id="installStressTool" onclick="installStressToolBtn()">스트레스 툴 설치</button>
                            </div><br>
                            <button onclick="startWebStressTest()">WEB 서버 과부하 테스트 시작</button>
                        </div>

                        <!-- WAS 서버 상태 박스 -->
                        <div class="server-box">
                            <h3>WAS 서버 상태</h3>
                            <p style="font-size: large;">CPU 사용량:
                                <span id="wasCpuUsage">&nbsp;0%</span></p>
                            <p style="font-size: large;">메모리 사용량:
                                <span id="wasMemoryUsage">&nbsp;0%</span></p>
                        </div>
                    </div>
                </section>
                <section>
                    <p
                        style="display: inline-block; vertical-align: text-bottom; margin-top: 40px; color: #173d61; font-weight: 600;">웹서버에 접속한 사용자들의 로그를 기록합니다.(WEB 서버)</p><br>
                    <small>
                        <span class="big-bullet"></span>&nbsp;웹서버에 접속한 사용자들의 접속 로그는 NAS(Network Attached Storage)에 기록됩니다.<br>
                        <span class="big-bullet"></span>&nbsp;HA(High Availability)와 오토스케일링 구성 시에도 각각의
                        웹서버는 동일한 디렉토리 내 동일한 파일에 접속 로그를 기록할 수 있습니다.<br>
                        <span class="big-bullet"></span>&nbsp;이는 여러 대의 웹서버가 로그를 중복해서 기록하지 않고, NAS에 통합하여
                        기록함으로써 로그를 효과적으로 관리하고 분석하는 데 도움이 됩니다.</small>
                    <!-- 로그 데이터 영역 상단에 설명 테이블 추가 -->
                    <table class="logDataDescriptionTable">
                        <tr>
                            <th>웹서버 접속 로그 (로그 경로: /n1/logs/access.log)</th>
                        </tr>
                    </table>

                    <!-- 로그 데이터 영역 -->
                    <div id="logData">
                        <!-- 로그 데이터는 여기에 표시됩니다 -->
                    </div>
                </section>
                <section>
                    <p
                        style="display: inline-block; vertical-align: text-bottom; margin-top: 40px; color: #173d61; font-weight: 600;">어플리케이션의 로그를 기록합니다.(WAS 서버)</p><br>
                    <small>
                        <span class="big-bullet"></span>&nbsp;WAS서버의 어플리케이션 로그는 LVM(Logical Volume Manager)을 활용하여 구성된 추가 볼륨에 기록됩니다.<br>
                        <span class="big-bullet"></span>&nbsp;LVM을 사용하면 어플리케이션 로그 파일의 크기가 증가해도 유연하게 대처할 수 있습니다.<br>
                        <span class="big-bullet"></span>&nbsp;LVM을 통해 디스크 공간을 유연하게 확장하고 축소할 수 있으며, 이를 통해
                        로그의 양이 증가해도 데이터의 안정성과 성능을 유지할 수 있습니다.</small>
                    <!-- 로그 데이터 영역 상단에 설명 테이블 추가 -->
                    <table class="logDataDescriptionTable">
                        <tr>
                            <th>어플리케이션 로그 (로그 경로: /waslog/app.log)</th>
                        </tr>
                    </table>

                    <!-- WAS 로그 데이터 영역 -->
                    <div id="wasLogData">
                        <!-- WAS 로그 데이터는 여기에 표시됩니다 -->
                    </div>
                </section>
            </article>

            <!-- 자바스크립트 코드 -->
            <script>
                // 페이지 로드 완료 후 실행될 코드
                document
                    .getElementById('checkServerStatusButton')
                    .addEventListener('click', checkServerStatus);
                // 제품 목록 로드 함수 개선
                function loadProductList() {
                    fetch('/api/products/list')
                        .then(response => response.json())
                        .then(data => {
                            productListElement.innerHTML = ''; // 기존 목록 초기화
                            data.forEach(product => {
                                const li = document.createElement('li');
                                // 제품 이름과 카테고리를 함께 표시
                                li.innerHTML = `${product.name} / <small>${product.category}</small>`;
                                li.dataset.productId = product.id;
                                li.addEventListener('click', () => {
                                    document
                                        .querySelectorAll('#productList li')
                                        .forEach(item => {
                                            item
                                                .classList
                                                .remove('selected-product');
                                        });
                                    li
                                        .classList
                                        .add('selected-product');
                                    loadProductDescription(product.id);
                                });
                                productListElement.appendChild(li);
                            });
                        })
                        .catch(error => {
                            console.error('서비스 목록 로드 실패:', error);
                            // 사용자에게 에러 메시지 표시
                            alert('어플리케이션이 정상적으로 작동하지 않아, \n서비스 목록을 불러오는 데 실패했습니다. 잠시 후 다시 시도해주세요.');
                        });
                }

                // 선택된 제품의 설명 로드
                function loadProductDescription(productId) {
                    fetch(`/api/products/description/${productId}`)
                        .then(
                            response => response.json()
                        )
                        .then(data => {
                            // 제품 설명을 페이지에 표시하는 로직
                            document
                                .getElementById('productDescription')
                                .innerText = data.description;
                        })
                        .catch(error => console.error('서비스 설명 로드 실패:', error));
                }

                document
                    .getElementById('productList')
                    .addEventListener('click', function (event) {
                        if (event.target.tagName === 'LI') {
                            // 모든 항목에서 'selected-product' 클래스 제거
                            var items = document.querySelectorAll('#productList li');
                            items.forEach(function (item) {
                                item
                                    .classList
                                    .remove('selected-product');
                            });

                            // 클릭된 항목에 'selected-product' 클래스 추가
                            event
                                .target
                                .classList
                                .add('selected-product');

                            // 클릭된 제품의 설명 로드 로직 (기존 코드 유지)
                            var productId = event.target.dataset.productId;
                            loadProductDescription(productId);
                        }
                    });

                function openAddProductWindow() {
                    // 새 창을 열 때의 옵션을 설정합니다. 여기서는 너비(width) 400px, 높이(height) 600px로 설정하고 있습니다. left와
                    // top 옵션으로 창의 위치를 지정할 수도 있습니다.
                    var windowFeatures = "width=400,height=600,left=100,top=100";

                    // window.open() 메소드를 사용하여 새 창을 엽니다.
                    window.open('addproduct.html', 'Add Product', windowFeatures);
                }

                // DOM 요소의 텍스트를 업데이트하는 함수
                function updateElementTextById(id, text) {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = text;
                    }
                }

                // 서버 상태 확인 함수(WEB 서버 내 NODE.JS 을 통해 작동)
                async function checkServerStatus() {
                    try {
                        const response = await fetch('/checkServerStatus');
                        const message = await response.text();
                        alert(message);
                    } catch (error) {
                        alert('Error: ' + error);
                    }
                }

                // 호스트 이름을 가져와서 HTML에 삽입하는 함수
                async function fetchAndDisplayHostname() {
                    try {
                        const response = await fetch('/hostname');
                        const data = await response.json();
                        document
                            .getElementById('hostname')
                            .textContent = data.hostname;
                    } catch (error) {
                        console.error('Error fetching hostname:', error);
                    }
                }

                // 로그 파일 내용을 가져오는 함수(WEB 서버 내 NODE.JS 을 통해 작동)
                function fetchLogContent() {
                    fetch('/logs')
                        .then(response => {
                            if (!response.ok) {
                                // NAS 연결 문제로 로그 기록 중단
                                throw new Error("NAS에 정상적으로 연결되지 않아 로그 기록이 중단되었습니다.");
                            }
                            return response.text();
                        })
                        .then(data => {
                            document
                                .getElementById('logData')
                                .innerText = data;
                        })
                        .catch(error => {
                            if (error.message === "NAS에 정상적으로 연결되지 않아 로그 기록이 중단되었습니다.") {
                                // NAS 연결 문제 메시지
                                document
                                    .getElementById('logData')
                                    .innerText = error.message;
                            } else {
                                // WEB 서버 작동 문제 메시지
                                document
                                    .getElementById('logData')
                                    .innerText = "서버가 정상적으로 작동하지 않아 로그 내용을 불러올 수 없습니다.";
                            }
                        });
                }

                // 전역 변수로 DOM 요소를 저장할 변수 선언
                const productListElement = document.getElementById('productList');

                // 전역 변수로 loader 요소 참조
                let loader;

                document.addEventListener('DOMContentLoaded', function () {
                    // DOM이 로드된 후 loader 요소 찾기
                    loader = document.querySelector('.loader');

                    // 이벤트 리스너 등록 및 기타 초기화 코드
                    document
                        .getElementById('checkServerStatusButton')
                        .addEventListener('click', checkServerStatus);

                    // 기타 필요한 함수 호출
                    fetchAndDisplayHostname();
                    fetchLogContent();
                    loadProductList();

                    // 주기적으로 실행되어야 하는 함수들
                    setInterval(fetchLogContent, 10000); // 10초마다 로그 내용 새로고침
                    setInterval(updateServerStatus, 2000); // 2초마다 서버 상태 업데이트
                });

                // 실시간으로 서버 상태를 업데이트하는 함수
                function updateServerStatus() {
                    fetch('/server-status')
                        .then(response => response.json())
                        .then(data => {
                            const webCpuUsageElement = document.getElementById('webCpuUsage');
                            updateUsageElement(webCpuUsageElement, data.cpuUsage);

                            document
                                .getElementById('webMemoryUsage')
                                .textContent = data
                                .memoryUsage
                                .toFixed(2) + '%';
                        })
                        .catch(error => console.error('WEB 서버 상태 정보를 불러오는 데 실패했습니다:', error));

                    fetch('/api/was-server-status')
                        .then(response => response.json())
                        .then(data => {
                            const wasCpuUsageElement = document.getElementById('wasCpuUsage');
                            updateUsageElement(wasCpuUsageElement, data.cpuUsage);

                            document
                                .getElementById('wasMemoryUsage')
                                .textContent = data
                                .memoryUsage
                                .toFixed(2) + '%';
                        })
                        .catch(error => console.error('WAS 서버 상태 정보를 불러오는 데 실패했습니다:', error));
                }

                // 사용량 업데이트 함수
                function updateUsageElement(element, usage) {
                    const usageText = usage.toFixed(2) + '%'; // 값이 변하지 않으므로 const 사용
                    element.textContent = usageText;
                    if (usage === 100) {
                        element.style.color = 'red';
                    } else {
                        element.style.color = 'white';
                    }
                }

                // 로더를 표시하는 함수
                function showLoader() {
                    loader.style.display = 'block';
                }

                // 로더를 숨기는 함수
                function hideLoader() {
                    loader.style.display = 'none';
                }

                // 웹 서버 스트레스 테스트 도구를 설치하는 함수
                function installStressToolBtn() {
                    showLoader();
                    fetch('/install-stress-test', {method: 'POST'})
                        .then(response => {
                            hideLoader();
                            if (response.ok) {
                                alert('웹 서버 스트레스 도구가 설치되었습니다.');
                            } else {
                                alert('스트레스 테스트 도구 설치 실패했습니다.');
                            }
                        })
                        .catch(error => {
                            hideLoader();
                            console.error('스트레스 테스트 설치 중 오류 발생:', error);
                            alert('스트레스 테스트 설치 중 오류가 발생했습니다.');
                        });
                }

                // 웹 서버 스트레스 테스트를 시작하는 함수
                function startWebStressTest() {
                    showLoader();
                    fetch('/start-stress-test', {method: 'POST'})
                        .then(response => {
                            hideLoader();
                            if (response.ok) {
                                alert('웹 서버 스트레스 테스트가 완료 되었습니다.');
                            } else {
                                alert('스트레스 테스트 시작에 실패했습니다.');
                            }
                        })
                        .catch(error => {
                            hideLoader();
                            console.error('스트레스 테스트 시작 중 오류 발생:', error);
                            alert('스트레스 테스트 시작 중 오류가 발생했습니다.');
                        });
                }
            </script>
        </main>
        <!-- client.js 파일 참조 -->
        <script src="client.js"></script>
    </body>
</html>